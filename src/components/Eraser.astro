---
// Components
import Icon from "@xtreat/astro-iconify"

// Islands
import { motion } from "motion/react"
import { toolDiff } from '../json/animationConfig.json' assert { type: 'json' };
---
<motion.button
    className="z-50 absolute bottom-5 right-5 size-16 disabled:pointer-events-none disabled:cursor-none transition-colors duration-300 text-pink-400 disabled:text-black"
    id="motion-eraser"
    initial={{ x: 64, opacity: 0}}
    animate={{transition: {type: "spring", ease: "easeOut", delay: toolDiff, duration: 0.5}, x: 0, opacity: 1}}
    whileHover={{ scale: 1.1, rotate: -5, cursor:"none"}}
    whileTap={{ scale: 0.9, rotate: -20, cursor:"none" }}
    whileDrag={{ scale: 0.9, rotate: -20, cursor:"none" }}
    dragConstraints={{ bottom: 0, right: 0, top: 0, left: 0 }}
    dragElastic={1}
    drag
    disabled
    client:only="react"
>
    <Icon class="size-full" icon="svg-spinners:pulse-rings-2" slot="fallback" />
    <Icon class="size-full" icon="fe:eraser" />
</motion.button>

<script>
import { $coloredElements } from '../scripts/stores/coloredElements.ts';
import eraserSFX from '../assets/sound/eraser.mp3';
const audio = new Audio(eraserSFX);
audio.volume = 0.5;

const mouseUpEvent = new MouseEvent('mouseup', {
  bubbles: true,
  cancelable: true,
  view: window
});

async function disableEraser() {
    await new Promise((r) => setTimeout(r, 150));
    if($coloredElements.get() <= 0){
        found.setAttribute('disabled', '');
        found.dispatchEvent(mouseUpEvent);
    }
}

const handleErasing = (event : Event) => {
    const canErase : Element[] = document.elementsFromPoint(event.clientX, event.clientY);
    canErase?.forEach((element : Element) => {
        if(!element.classList.contains('grayscale') && element.classList.contains('remove-grayscale')) {
            element.classList.add('grayscale');
            audio.play();
            const newVal = $coloredElements.get() - 1;
            $coloredElements.set(newVal >= 0 ? newVal : 0);
            disableEraser();
        }
    });
};

let found : Element;
const interval = setInterval(() => {
    const eraser = document.querySelector('#motion-eraser');
    eraser?.addEventListener('mousemove', handleErasing);
    if(eraser) {found = eraser; clearInterval(interval);}
}, 200)

const listener = $coloredElements.listen((cur) => {
    if(cur > 0){
        found?.removeAttribute('disabled');
    }
});

</script>